import requests
from requests.packages.urllib3.exceptions import InsecureRequestWarning

# Suppress only the single InsecureRequestWarning from urllib3
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

# Server details
base_url = 'http://your-microstrategy-server.com/MicroStrategyLibrary/api'
username = 'your_username'
password = 'your_password'

# Endpoint for authentication
auth_endpoint = f"{base_url}/auth/login"

# Login payload
auth_payload = {
    "username": username,
    "password": password
}

# Headers
headers = {
    'Content-Type': 'application/json',
    'Accept': 'application/json'
}

# Try to authenticate and get the authToken, with verify=False to bypass SSL verification
try:
    response = requests.post(auth_endpoint, json=auth_payload, headers=headers, verify=False)
    response.raise_for_status()  # Raises an HTTPError for bad requests
    authToken = response.headers.get('X-MSTR-AuthToken')
    if not authToken:
        print("Authentication failed, no token received.")
        exit()
    cookies = response.cookies
    print("Authentication successful!")
except requests.exceptions.RequestException as e:
    print(f"Failed to authenticate: {e}")
    exit()

# Endpoint to list projects
projects_endpoint = f"{base_url}/projects"

# Try to fetch projects, with verify=False to bypass SSL verification
try:
    projects_response = requests.get(projects_endpoint, headers={
        'X-MSTR-AuthToken': authToken,
        'Accept': 'application/json'
    }, cookies=cookies, verify=False)
    projects_response.raise_for_status()
    projects = projects_response.json()
    print("Projects retrieved successfully:")
    for project in projects:
        print(f"Project ID: {project['id']}, Name: {project['name']}")
except requests.exceptions.RequestException as e:
    print(f"Failed to retrieve projects: {e}")

# Logout (optional but recommended), with verify=False to bypass SSL verification
logout_endpoint = f"{base_url}/auth/logout"
try:
    logout_response = requests.post(logout_endpoint, headers={'X-MSTR-AuthToken': authToken}, cookies=cookies, verify=False)
    logout_response.raise_for_status()
    print("Logged out successfully.")
except requests.exceptions.RequestException as e:
    print(f"Failed to log out: {e}")
