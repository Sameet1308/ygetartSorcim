import re
from mstrio.connection import Connection
from mstrio.server import Environment
from mstrio.project_objects import list_all_cubes, OlapCube
import getpass
import pandas as pd
import warnings

# Suppress warnings if you have certificate verification issues
warnings.filterwarnings("ignore")

def export_to_excel(filename, df):
    with pd.ExcelWriter(f"{filename}.xlsx", engine='openpyxl') as writer:
        df.to_excel(writer, index=False, sheet_name='Data')

# Connection details
SERVER_URL = "https://env-XXXXXX.customer.cloud.microstrategy.com/MicroStrategyLibrary"
USERNAME = "mstr"
PASSWORD = getpass.getpass(prompt='Password ')

# Establish connection
conn = Connection(SERVER_URL, username=USERNAME, password=PASSWORD, ssl_verify=False)
conn.connect()

# List projects using the Environment class
env = Environment(connection=conn)
projects = env.list_projects()

# Enhanced Regex for a simplistic join and table-column association (Not robust for complex SQL)
join_pattern = re.compile(r'''
    JOIN\s+(\w+)\s+.*?\s+ON\s+(?:\w+\.)?(\w+)\s*=\s*(?:\w+\.)?(\w+)
    ''', re.IGNORECASE | re.VERBOSE)

# Lists for results
detailed_results = []
sql_results = []

for project in projects:
    proj_conn = Connection(SERVER_URL, USERNAME, PASSWORD, project_id=project.id, ssl_verify=False)
    proj_conn.connect()

    cubes_as_dicts = list_all_cubes(connection=proj_conn, to_dictionary=True)

    for cube in cubes_as_dicts:
        cube_id, cube_name, cube_type = cube["id"], cube["name"], cube.get("type", "Unknown")
        try:
            current_cube = OlapCube(connection=proj_conn, id=cube_id)
            sql_view = current_cube.export_sql_view()

            if sql_view:
                sql_results.append([project.name, cube_id, cube_name, cube_type, sql_view])

                # Simple join and column mapping (assumes very basic SQL structure)
                matches = join_pattern.findall(sql_view)
                for match in matches:
                    table, left_col, right_col = match
                    detailed_results.append([project.name, cube_id, cube_name, cube_type, table, left_col])
                    detailed_results.append([project.name, cube_id, cube_name, cube_type, table, right_col])
            else:
                sql_results.append([project.name, cube_id, cube_name, cube_type, "SQL view is empty"])
        except Exception as e:
            sql_results.append([project.name, cube_id, cube_name, cube_type, f"Error retrieving SQL: {str(e)}"])

    proj_conn.close()

conn.close()

# DataFrames
df_detailed = pd.DataFrame(detailed_results, columns=["Project Name", "Cube ID", "Cube Name", "Cube Type", "Table Name", "Column Name"])
df_sql = pd.DataFrame(sql_results, columns=["Project Name", "Cube ID", "Cube Name", "Cube Type", "Cube SQL"])

# Export to Excel
export_to_excel("cubes_tables_columns", df_detailed)
export_to_excel("cubes_sql_views", df_sql)

print("Export complete. DataFrames saved to Excel.")